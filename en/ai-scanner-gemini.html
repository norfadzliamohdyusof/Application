<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles.css">
    <script src="../script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
    <title>NeuroSort</title> <!-- Title of the website -->
</head>

<body>
    <!-- Header -->
    <div class="header">
        <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        <div class="logo">NeuroSort</div>
        <img src="../Images/logo.png" alt="NeuroSort Logo">
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../Images/logo.png" alt="NeuroSort Logo">
            <div class="top-name">NeuroSort</div>
        </div>
        <nav class="nav-menu">
            <a href="application.html" class="nav-item">
                <i>üè†</i>
                <span>Home</span>
            </a>
            <a href="https://wa.me/60123456789" class="nav-item">
                <i>‚ùì</i>
                <span>Contact Us</span>
            </a>
            <a href="setting.html" class="nav-item">
                <i>‚öôÔ∏è</i>
                <span>Settings</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="upload-container">
            <h1 class="upload-title">Upload Image</h1>
            <p class="upload-subtitle">Select your image file here</p>
            <div class="upload-hint">Supports JPG, PNG, HEIC</div>

            <button class="browse-btn" onclick="document.getElementById('fileInput').click()">
                Browse Files
            </button>

            <input type="file" id="fileInput" class="file-input" accept="image/*" capture="user">

            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
                <img class="preview-image" id="previewImage" alt="Preview">
            </div>

            <div>
                <button id="predictBtn" onclick="predict(fileInput.files[0])">Scan This Image</button>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Footer Tab Bar -->
    <div class="footer-tab-bar">
        <span>Be Smart, Be Green, Be NeuroSort</span>
    </div>
</body>

<script>

// Function to handle file selection and display information
document.getElementById('fileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const fileNameElement = document.getElementById('fileName');
    const fileSizeElement = document.getElementById('fileSize');
    const previewImage = document.getElementById('previewImage');
    const fileInfoDiv = document.getElementById('fileInfo');

    if (file) {
        fileNameElement.textContent = `File: ${file.name}`;
        fileSizeElement.textContent = `Size: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
        fileInfoDiv.style.display = 'block';

        // Handle HEIC files using the heic2any library included in HTML
        if (file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif')) {
            // Read the HEIC file as a Blob
            file.arrayBuffer().then(buffer => {
                return heic2any({
                    blob: new Blob([buffer], { type: file.type }),
                    toType: "image/jpeg"
                });
            }).then(conversionBlob => {
                // Display the converted JPEG image
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                };
                reader.readAsDataURL(conversionBlob);
            }).catch(e => {
                console.error("HEIC conversion failed:", e);
                alert("HEIC conversion failed. Please try a different format.");
            });
        } else {
            // Standard image preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    } else {
        fileNameElement.textContent = '';
        fileSizeElement.textContent = '';
        previewImage.src = '';
        previewImage.style.display = 'none';
        fileInfoDiv.style.display = 'none';
    }
});


    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const previewImage = document.getElementById('previewImage');
    const uploadTitle = document.querySelector('.upload-title');
    const uploadSubtitle = document.querySelector('.upload-subtitle');
    const uploadHint = document.querySelector('.upload-hint');
    const browseBtn = document.querySelector('.browse-btn');
    const predictBtn = document.getElementById('predictBtn');

    // File input change handler
    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    // Function to handle file selection
    async function handleFiles(files) {
        if (files.length > 0) {
            let file = files[0];

            // Update UI to show processing state
            uploadTitle.textContent = "Please wait...";
            uploadSubtitle.textContent = 'Wait a while we are processing your image';
            uploadHint.style.display = 'none';
            browseBtn.style.display = 'none';

            // Check if file is HEIC/HEIF
            if (file.type === "image/heic" || file.name.toLowerCase().endsWith(".heic") || file.type === "image/heif") {
                try {

                    // Convert HEIC to JPEG
                    const convertedBlob = await heic2any({
                        blob: file,
                        toType: "image/jpeg",  // or "image/png"
                        quality: 0.9
                    });
                    // Replace file with converted one
                    file = new File([convertedBlob], file.name.replace(/\.heic$/i, ".jpg"), { type: "image/jpeg" });
                } catch (e) {
                    alert("Failed to convert HEIC image.");
                    console.error(e);
                    return;
                }
            }

            // Check if file is an image
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }

            // Check file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB.');
                return;
            }

            // Update UI to show file info and enable predict button
            predictBtn.style.display = 'inline';
            uploadTitle.textContent = "AI Scanner Ready";
            uploadSubtitle.textContent = 'Click "Scan This Image" to proceed scanning for trash type!';

            displayFileInfo(file);
        }
    }

    // Function to display file information and preview
    function displayFileInfo(file) {

        // Create preview
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';
        };
        reader.readAsDataURL(file);

        fileInfo.classList.add('show');
    }

    // Function to format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

 
async function predict(file) {

     // Show loading state
        showLoadingState();


        console.log("Gemini Prediction Result:", file);


    if (!file) {
        alert("Please select an image file first.");
        return;
    }

/*     const predictBtn = document.getElementById('predictBtn');
    predictBtn.disabled = true;
    predictBtn.textContent = 'Scanning... Please wait.'; */

    try {
        // 1. Convert the file to a format suitable for Gemini (e.g., Base64 or Blob)
        // For simple AJAX/Fetch, we'll use a FormData object.
        const formData = new FormData();
        formData.append('image', file);
        
        // Add a text prompt for the Gemini model
        const geminiPrompt = "Analyze this image. Identify the item and classify it into one of these categories: 'Recycle (Plastic / Paper / Metal / Glass)',  'Compost (Organic)', or 'Non-Recyclable (Trash)'. Also, provide a brief, friendly instruction on its proper disposal.";
        formData.append('prompt', geminiPrompt);


        // 2. Make the request to your secure backend API
        // *** IMPORTANT: Replace '/api/gemini-predict' with your actual backend endpoint ***
        const response = await fetch('http://127.0.0.1:5000/api/gemini-predict', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();

        // 3. Process the results from the Gemini API
        console.log("Gemini Prediction Result:", data);

        const resultText = data.prediction || "Prediction service returned no text.";
        const category = data.category || "Unclassified"; // Assuming your backend structures the JSON response

        // Display the results to the user
        alert(`NeuroSort Result:\n\nCategory: ${category}\n\nInstructions:\n${resultText}`);
        

            // Check if objects were detected
                const hasDetections = checkForDetections(data);

                if (hasDetections) {
                    //  Objects detected - save data and redirect
                    saveDataAndRedirect(data, file);
                } else {
                    // No objects detected - show no detection UI
                    showNoDetectionState();
                }


               
        /* const resultText = data.prediction || "Prediction service returned no text.";
        const category = data.category || "Unclassified"; // Assuming your backend structures the JSON response

        // Display the results to the user
        alert(`NeuroSort Result:\n\nCategory: ${category}\n\nInstructions:\n${resultText}`);
        
        // You would typically navigate to a results page here, 
        window.location.href = `results.html?data=${encodeURIComponent(JSON.stringify(data))}`;
 */
    } catch (error) {
        console.error("Prediction failed:", error);
        alert(`Failed to scan image. Please check the console for details. (Error: ${error.message})`);
    } finally {
        predictBtn.disabled = false;
        predictBtn.textContent = 'Scan This Image';
    }
}




    // Check if server response contains object detections
    function checkForDetections(data) {       
        
        // Handle specific API response format
        if (data && data.success === true && data.category && data.prediction) {
            return true;
        }

        return false;
    }

    // Save response data and image, then redirect to results
    function saveDataAndRedirect(data, imageFile) {

/*         const resultText = data.prediction || "Prediction service returned no text.";
        const category = data.category || "Unclassified"; // Assuming your backend structures the JSON response

        // Display the results to the user
        alert(`NeuroSort Result:\n\nCategory: ${category}\n\nInstructions:\n${resultText}`);
        
        // You would typically navigate to a results page here, 
        window.location.href = `results.html?data=${encodeURIComponent(JSON.stringify(data))}`;
 */



        // Extract predictions from your API format
        const predictionString = data.prediction || "Prediction service returned no text.";
        const category = data.category || "Unclassified"; // Assuming your backend structures the JSON response

        // Regular Expression 1: Capture the Item
        // Looks for the exact phrase '**Item:**' followed by any characters until the next newline.
        const itemRegex = /\*\*Item:\*\*(.*?)\n/; 
        const itemMatch = predictionString.match(itemRegex);
        const         itemValue = itemMatch ? itemMatch[1].trim() : 'Not found';

        // Regular Expression 2: Capture the Classification
        // Looks for the exact phrase '**Category:**' followed by any characters until the next newline.
        const classifictionRegex = /\*\*Category:\*\*(.*?)\n/;
        const classificationMatch = predictionString.match(classificationRegex);
        const classificationValue = classificationMatch ? classificationMatch[1].trim():'Not found';

        // Regular Expression 3: Capture the Disposal Instruction
        // This is more complex: it looks for the start of the instruction and captures
        // everything until the end of the string (since it's the last element).
        const instructionRegex = /\*\*Disposal Instruction:\*\*(.*)/s; 
        const instructionMatch = predictionString.match(instructionRegex);

        // We need an extra step to remove the quotes around the instruction text.
        let instructionValue = 'Not found';
        if (instructionMatch) {
            // Capture group [1] is the text after the label.
            instructionValue = intructionMatch[1].trim(); 
            
            // Remove the surrounding quotes (") from the instruction text
            instructionValue = instructionValue.replace(/^"|"$/g, '');
        }


        console.log("--- Extracted Values ---");
        console.log(`Item: ${itemValue}`);
        console.log(`Classification: ${classificationValue}`);
        console.log(`Disposal Instruction: ${instructionValue}`);


        // Save predictions to localStorage
        localStorage.setItem("prediction", JSON.stringify(prediction));
        localStorage.setItem("category", JSON.stringify(category));

        // Convert image to base64 and save to sessionStorage
        resizeImage(imageFile, 640, 640, 0.7).then((compressedBase64) => {
            sessionStorage.setItem("uploadedImage", compressedBase64);
            window.location.href = "result.html";
        }).catch(() => {
            console.error("Failed to process image");
            showErrorState();
        });
    }

    function resizeImage(file, maxWidth = 640, maxHeight = 640, quality = 0.7) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    let canvas = document.createElement("canvas");
                    let ctx = canvas.getContext("2d");

                    // Maintain aspect ratio
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to JPEG (quality 0.7 = 70%)
                    const resizedBase64 = canvas.toDataURL("image/jpeg", quality);
                    resolve(resizedBase64);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // Show loading state
    function showLoadingState() {
        updateUI("Scanning Image...", "Wait a while we are scanning your image", false);
        showLoader();
    }

    // Show no detection state
    function showNoDetectionState() {
        updateUI("No Trash Detected", "Please try again with a different image.", false);
        hideLoader();
    }

    // Show error state
    function showErrorState() {
        updateUI("Error Occurred", "Failed to connect to server. Please try again.", false);
        hideLoader();
    }

    // Reset to ready state
    function showReadyState() {
        updateUI("AI Scanner Ready", 'Click "Scan This Image" to proceed scanning for trash type!', true);
        hideLoader();
    }

    // Helper function to update UI elements
    function updateUI(title, subtitle, showButton) {
        const titleElement = document.getElementById("uploadTitle") || document.querySelector(".upload-title");
        const subtitleElement = document.getElementById("uploadSubtitle") || document.querySelector(".upload-subtitle");
        const buttonElement = document.getElementById("predictBtn") || document.querySelector(".predict-btn");

        if (titleElement) titleElement.textContent = title;
        if (subtitleElement) subtitleElement.textContent = subtitle;
        if (buttonElement) buttonElement.style.display = showButton ? "inline" : "none";
    }

    // Loader functions
    function showLoader() {
        let loader = document.getElementById("loader-wrapper");
        if (!loader) {
            loader = document.createElement("div");
            loader.id = "loader-wrapper";
            loader.className = "load-wrapp";
            loader.innerHTML = `
            <div class="load">
                <div class="line"></div>
                <div class="line"></div>
                <div class="line"></div>
            </div>
        `;
            const subtitle = document.getElementById("uploadSubtitle") || document.querySelector(".upload-subtitle");
            if (subtitle) {
                subtitle.insertAdjacentElement("afterend", loader);
            }
        }
    }

    function hideLoader() {
        const loader = document.getElementById("loader-wrapper");
        if (loader) {
            loader.remove();
        }
    }
</script>

</html>
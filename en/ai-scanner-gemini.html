<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles.css">
    <script src="../script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
    <title>NeuroSort</title> <!-- Title of the website -->
</head>

<body>
    <!-- Header -->
    <div class="header">
        <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        <div class="logo">NeuroSort</div>
        <img src="../Images/logo.png" alt="NeuroSort Logo">
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../Images/logo.png" alt="NeuroSort Logo">
            <div class="top-name">NeuroSort</div>
        </div>
        <nav class="nav-menu">
            <a href="application.html" class="nav-item">
                <i>üè†</i>
                <span>Home</span>
            </a>
            <a href="https://wa.me/60123456789" class="nav-item">
                <i>‚ùì</i>
                <span>Contact Us</span>
            </a>
            <a href="setting.html" class="nav-item">
                <i>‚öôÔ∏è</i>
                <span>Settings</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="upload-container">
            <h1 class="upload-title">Upload Image</h1>
            <p class="upload-subtitle">Select your image file here</p>
            <div class="upload-hint">Supports JPG, PNG, HEIC</div>

            <button class="browse-btn" onclick="document.getElementById('fileInput').click()">
                Browse Files
            </button>

            <input type="file" id="fileInput" class="file-input" accept="image/*" capture="user">

            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
                <img class="preview-image" id="previewImage" alt="Preview">
            </div>

            <div>
                <button id="predictBtn" onclick="predict(fileInput.files[0])">Scan This Image</button>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Footer Tab Bar -->
    <div class="footer-tab-bar">
        <span>Be Smart, Be Green, Be NeuroSort</span>
    </div>
</body>

<script>
   // A simple function to toggle the sidebar
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
}

// Function to handle file selection and display information
document.getElementById('fileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const fileNameElement = document.getElementById('fileName');
    const fileSizeElement = document.getElementById('fileSize');
    const previewImage = document.getElementById('previewImage');
    const fileInfoDiv = document.getElementById('fileInfo');

    if (file) {
        fileNameElement.textContent = `File: ${file.name}`;
        fileSizeElement.textContent = `Size: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
        fileInfoDiv.style.display = 'block';

        // Handle HEIC files using the heic2any library included in HTML
        if (file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif')) {
            // Read the HEIC file as a Blob
            file.arrayBuffer().then(buffer => {
                return heic2any({
                    blob: new Blob([buffer], { type: file.type }),
                    toType: "image/jpeg"
                });
            }).then(conversionBlob => {
                // Display the converted JPEG image
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                };
                reader.readAsDataURL(conversionBlob);
            }).catch(e => {
                console.error("HEIC conversion failed:", e);
                alert("HEIC conversion failed. Please try a different format.");
            });
        } else {
            // Standard image preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    } else {
        fileNameElement.textContent = '';
        fileSizeElement.textContent = '';
        previewImage.src = '';
        previewImage.style.display = 'none';
        fileInfoDiv.style.display = 'none';
    }
});


/**
 * Main function to prepare and send the image to a backend endpoint for 
 * trash detection using the Gemini API.
 * * NOTE: The actual Gemini API call must happen server-side to secure the API key.
 * This function sends the file to a secure backend route (/api/gemini-predict).
 * * @param {File} file The image file selected by the user.
 */
async function predict(file) {
    if (!file) {
        alert("Please select an image file first.");
        return;
    }

    const predictBtn = document.getElementById('predictBtn');
    predictBtn.disabled = true;
    predictBtn.textContent = 'Scanning... Please wait.';

    try {
        // 1. Convert the file to a format suitable for Gemini (e.g., Base64 or Blob)
        // For simple AJAX/Fetch, we'll use a FormData object.
        const formData = new FormData();
        formData.append('image', file);
        
        // Add a text prompt for the Gemini model
        const geminiPrompt = "Analyze this image. Identify the item and classify it into one of these categories: 'Recycle (Plastic/Paper/Metal)', 'Compost (Organic)', or 'Non-Recyclable (Trash)'. Also, provide a brief, friendly instruction on its proper disposal.";
        formData.append('prompt', geminiPrompt);


        // 2. Make the request to your secure backend API
        // *** IMPORTANT: Replace '/api/gemini-predict' with your actual backend endpoint ***
        const response = await fetch('/api/gemini-predict', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();

        // 3. Process the results from the Gemini API
        console.log("Gemini Prediction Result:", data);
        
        const resultText = data.prediction || "Prediction service returned no text.";
        const category = data.category || "Unclassified"; // Assuming your backend structures the JSON response

        // Display the results to the user
        alert(`NeuroSort Result:\n\nCategory: ${category}\n\nInstructions:\n${resultText}`);
        
        // You would typically navigate to a results page here, 
        // e.g., window.location.href = `results.html?data=${encodeURIComponent(JSON.stringify(data))}`;

    } catch (error) {
        console.error("Prediction failed:", error);
        alert(`Failed to scan image. Please check the console for details. (Error: ${error.message})`);
    } finally {
        predictBtn.disabled = false;
        predictBtn.textContent = 'Scan This Image';
    }
}
</script>

</html>